{% extends 'base.html' %}
{% block content %}
<div class="max-w-4xl mx-auto py-10">
  <h1 class="text-2xl font-bold text-gray-800 mb-6">Your Cart</h1>

  <div id="cart-container" class="space-y-4"></div>
  <div id="cart-total" class="text-right text-lg font-semibold mt-6"></div>

  <div class="text-right mt-6">
    <button id="checkout-btn"
            class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition">
      Checkout
    </button>
  </div>
</div>

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function() {
  const cart = JSON.parse(localStorage.getItem("cart")) || {};
  const container = document.getElementById("cart-container");
  const totalEl = document.getElementById("cart-total");

  // Show empty cart message
  if (Object.keys(cart).length === 0) {
    container.innerHTML = `<p class="text-gray-500 text-center">Your cart is empty üõí</p>`;
    totalEl.innerHTML = "";
    return;
  }

  let total = 0;
  let html = "";

  // Build cart display
  Object.entries(cart).forEach(([id, item]) => {
    total += item.price * item.qty;
    html += `
      <div class="flex items-center justify-between bg-white shadow rounded-lg p-4">
        <div>
          <h2 class="font-semibold text-gray-800">${item.name}</h2>
          <p class="text-gray-500">‚Çπ${item.price} √ó ${item.qty}</p>
        </div>
        <button onclick="removeFromCart('${id}')"
          class="text-red-500 hover:text-red-700">Remove</button>
      </div>
    `;
  });

  container.innerHTML = html;
  totalEl.innerHTML = `Total: ‚Çπ${total.toFixed(2)}`;

  // ‚úÖ Handle checkout click
  document.getElementById("checkout-btn").addEventListener("click", async function() {
    if (Object.keys(cart).length === 0) {
      alert("Your cart is empty.");
      return;
    }

    const csrftoken = document.cookie.split('; ')
        .find(r => r.startsWith('csrftoken='))
        ?.split('=')[1];

    try {
      const res = await fetch("{% url 'orders:save_cart_session' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrftoken
        },
        body: JSON.stringify(cart)
      });

      const data = await res.json();
      if (data.status === "success") {
        console.log("‚úÖ Cart synced with backend");
        window.location.href = "{% url 'orders:checkout' %}";
      } else {
        alert("‚ö†Ô∏è Could not sync cart with server.");
      }
    } catch (err) {
      console.error("Cart sync failed:", err);
      alert("‚ö†Ô∏è Error syncing cart. Try again.");
    }
  });
});
</script>
{% endblock %}
{% endblock %}
